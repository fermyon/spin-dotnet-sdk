#include <stdlib.h>
#include <string.h>

#include "./spin-http.h"

#include <mono-wasi/driver.h>
#include <mono/metadata/assembly.h>
#include <mono/metadata/class.h>
#include <mono/metadata/appdomain.h>
#include <mono/metadata/image.h>
#include <mono/metadata/metadata.h>
#include <mono/metadata/object.h>
#include <mono/metadata/debug-helpers.h>
#include <mono/metadata/reflection.h>
#include <mono/utils/mono-publib.h>

#include "./util.h"

// These are generated by the WASI SDK during build
const char* dotnet_wasi_getentrypointassemblyname();
const char* dotnet_wasi_getbundledfile(const char* name, int* out_length);
void dotnet_wasi_registerbundledassemblies();

MonoArray* string_pair_array(MonoClass* pair_class, spin_http_tuple2_string_string_t *values, size_t len) {
    MonoArray* array = mono_array_new(mono_domain_get(), pair_class, len);
    for (size_t index = 0; index < len; ++index) {
        MonoObject* pair = mono_object_new(mono_domain_get(), pair_class);
        mono_runtime_object_init(pair);
        set_field(pair_class, pair, "Key", mono_string_new(mono_domain_get(), values[index].f0.ptr));
        set_field(pair_class, pair, "Value", mono_string_new(mono_domain_get(), values[index].f1.ptr));
        mono_array_setref(array, index, pair);
    }
    return array;
}

MonoArray* body_array(spin_http_option_body_t* body) {
    MonoClass* byte_class = mono_get_byte_class();
    if (body->is_some) {
        spin_http_body_t* val = &body->val;
        MonoArray* array = mono_array_new(mono_domain_get(), byte_class, val->len);
        mono_value_copy_array(array, 0, val->ptr, val->len);
        return array;    
    } else {
        return mono_array_new(mono_domain_get(), byte_class, 0);
    }
}

MonoObject* wit_request_to_interop_request(MonoImage* sdk_image, MonoClass* builder_class, spin_http_request_t *req) {
    MonoObject* builder = mono_object_new(mono_domain_get(), builder_class);
    mono_runtime_object_init(builder);

    MonoClass* pair_class = mono_class_from_name(sdk_image, "Fermyon.Spin.Sdk", "StringPair");

    set_field(builder_class, builder, "Method", &(req->method));

    MonoString* uri_value = mono_string_new(mono_domain_get(), req->uri.ptr);
    set_field(builder_class, builder, "Uri", uri_value);

    MonoArray* header_value = string_pair_array(pair_class, req->headers.ptr, req->headers.len);
    set_field(builder_class, builder, "Headers", header_value);

    MonoArray* params_value = string_pair_array(pair_class, req->params.ptr, req->params.len);
    set_field(builder_class, builder, "Parameters", params_value);

    MonoArray* body_value = body_array(&req->body);
    set_field(builder_class, builder, "Body", body_value);

    return builder;
}

MonoObject* sdk_response_to_interop_response(MonoObject* resp) {
    MonoClass* resp_class = mono_object_get_class(resp);
    MonoMethod* to_interop = mono_class_get_method_from_name(resp_class, "ToInterop", 0);
    MonoObject* resp_interop = mono_wasm_invoke_method(to_interop, resp, NULL, NULL);

    return resp_interop;
}

spin_http_response_t interop_response_to_wit_response(MonoObject* response_obj) {
    MonoClass* response_class = mono_object_get_class(response_obj);

    uint16_t status;
    get_field(response_class, response_obj, "Status", &status);

    MonoArray* headers;
    get_field(response_class, response_obj, "Headers", &headers);

    MonoArray* body;
    get_field(response_class, response_obj, "Body", &body);

    uintptr_t headers_len = mono_array_length(headers);
    
    spin_http_option_headers_t h;

    if (headers_len == 0) {
        h.is_some = false;
        h.val.ptr = NULL;
        h.val.len = 0;
    } else {
        spin_http_tuple2_string_string_t* header_tuples = (spin_http_tuple2_string_string_t*)malloc(headers_len * sizeof(spin_http_tuple2_string_string_t));
        for (int index = 0; index < headers_len; ++index) {
            MonoObject* string_pair = mono_array_get(headers, MonoObject*, index);
            MonoString* key_obj;
            MonoString* value_obj;
            get_field(mono_object_get_class(string_pair), string_pair, "Key", &key_obj);
            get_field(mono_object_get_class(string_pair), string_pair, "Value", &value_obj);
            char* key_c_str = mono_wasm_string_get_utf8(key_obj);
            char* value_c_str = mono_wasm_string_get_utf8(value_obj);
            spin_http_string_t key = { key_c_str, strlen(key_c_str) };
            spin_http_string_t value = { value_c_str, strlen(value_c_str) };
            header_tuples[index].f0 = key;
            header_tuples[index].f1 = value;
        }
        h.is_some = true;
        h.val.ptr = header_tuples;
        h.val.len = headers_len;
    };
    
    uintptr_t bod_len = mono_array_length(body);
    uint8_t* body_bytes = (uint8_t*)malloc(bod_len * sizeof(uint8_t));
    
    // TODO: feels like this should be blittable since it is in the other direction...
    for (int index = 0; index < bod_len; ++index) {
        body_bytes[index] = mono_array_get(body, uint8_t, index);
    }

    spin_http_option_body_t wit_body = {
        true,
        { body_bytes, bod_len }
    };
    spin_http_response_t wit_response = {
        status,
        h,
        wit_body
    };

    return wit_response;
}

MonoObject* interop_request_to_sdk_request(MonoClass* builder_class, MonoObject* builder) {
    MonoMethod* build_method = mono_class_get_method_from_name(builder_class, "Build", 0);
    MonoObject* request_instance = mono_wasm_invoke_method(build_method, builder, NULL, NULL);
    return request_instance;
}

MonoObject* call_clr_request_handler(MonoMethod* handler, MonoObject* request_obj) {
    void *params[1];
    params[0] = request_obj;

    MonoObject* exn = NULL;
    MonoObject* response_obj = mono_wasm_invoke_method(handler, NULL, params, &exn);
    if (exn) {
        // strcat(message, "    ...but exception\n");
    }

    return response_obj;
}

void spin_http_handle_http_request(spin_http_request_t *req, spin_http_response_t *ret0) {
    dotnet_wasi_registerbundledassemblies();
    mono_wasm_load_runtime("", 0);

    MonoMethod* handler;
    MonoClass* builder_class;
    MonoImage* sdk_image;
    entry_points_err_t entry_points_err = find_entry_points("Fermyon.Spin.Sdk.HttpHandlerAttribute", "HttpRequestInterop", &handler, &builder_class, &sdk_image);
    if (entry_points_err) {
        return;
    }

    MonoObject* request_interop = wit_request_to_interop_request(sdk_image, builder_class, req);
    MonoObject* request_obj = interop_request_to_sdk_request(builder_class, request_interop);
    MonoObject* response_obj = call_clr_request_handler(handler, request_obj);
    MonoObject* response_interop = sdk_response_to_interop_response(response_obj);
    spin_http_response_t resp = interop_response_to_wit_response(response_interop);

    *ret0 = resp;
}
